---
import WebsiteLayout from '../../../../layouts/WebsiteLayout.astro'
import { getLabs, getLabSlugs, getLabBySlug, getCourses, getCourseBySlug } from '../../../../lib/api'
import { courseJsonLd, breadcrumbJsonLd } from '../../../../lib/seo'

export async function getStaticPaths() {
  const labs = await getLabs()
  const courses = await getCourses()
  return courses.map(course => {
    const lab = labs.find(l => l.id === course.labId)
    return {
      params: { labSlug: lab?.slug, courseSlug: course.slug },
    }
  }).filter(p => p.params.labSlug)
}

const { labSlug, courseSlug } = Astro.params
const labs = await getLabs()
const lab = await getLabBySlug(labSlug!)
const course = await getCourseBySlug(courseSlug!)
if (!lab || !course) return Astro.redirect('/404')

const relatedCourses = (await getCourses(lab.id)).filter(c => c.id !== course.id).slice(0, 3)

const jsonLd = [
  courseJsonLd(course, lab),
  breadcrumbJsonLd([
    { name: 'Accueil', url: '/' },
    { name: lab.name, url: `/${labSlug}/` },
    { name: 'Academy', url: `/${labSlug}/academy/` },
    { name: course.title, url: `/${labSlug}/academy/${courseSlug}/` },
  ]),
]
---

<WebsiteLayout
  title={course.title}
  description={course.shortDescription}
  image={course.image}
  labs={labs}
  currentLabSlug={labSlug}
  jsonLd={jsonLd}
  type="article"
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-stone-400 mb-6">
      <a href="/" class="hover:text-stone-600 dark:text-stone-400">Accueil</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/`} class="hover:text-stone-600 dark:text-stone-400">{lab.name}</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/academy/`} class="hover:text-stone-600 dark:text-stone-400">Academy</a>
      <span class="mx-2">›</span>
      <span class="text-stone-600 dark:text-stone-400">{course.title}</span>
    </nav>

    <img src={course.image} alt={course.title} class="w-full h-64 md:h-96 object-cover rounded-2xl mb-8" />

    <div class="flex flex-wrap gap-3 mb-4">
      <span class="px-3 py-1 bg-[#B01A19]/10 text-[#B01A19] text-sm font-medium rounded-full">{course.category}</span>
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{course.level}</span>
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{course.format}</span>
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{course.duration}</span>
    </div>

    <h1 class="text-4xl font-bold text-stone-800 mb-4" style="font-family: var(--font-heading)">
      {course.title}
    </h1>

    <p class="text-lg text-stone-600 mb-8">{course.shortDescription}</p>

    <div class="grid md:grid-cols-3 gap-8 mb-10">
      <div class="md:col-span-2 prose prose-stone max-w-none">
        <p>{course.description}</p>
        {course.instructors.length > 0 && (
          <div class="mt-6">
            <h3>Formateur{course.instructors.length > 1 ? 's' : ''}</h3>
            <ul>
              {course.instructors.map(i => <li>{i}</li>)}
            </ul>
          </div>
        )}
      </div>

      <aside class="bg-stone-50 dark:bg-stone-800 rounded-2xl p-6 border border-stone-200 h-fit sticky top-20">
        <div class="text-3xl font-bold text-stone-800 mb-1">{course.price}€</div>
        <p class="text-sm text-stone-500 mb-4">{course.duration} · {course.format}</p>

        <div class="space-y-3 mb-6 text-sm">
          <div class="flex justify-between">
            <span class="text-stone-500 dark:text-stone-400">Prochaine session</span>
            <span class="font-medium text-stone-700">{new Date(course.nextSession).toLocaleDateString('fr-FR')}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-stone-500 dark:text-stone-400">Places restantes</span>
            <span class="font-medium text-stone-700">{course.spotsAvailable}/{course.spotsTotal}</span>
          </div>
          {course.location && (
            <div class="flex justify-between">
              <span class="text-stone-500 dark:text-stone-400">Lieu</span>
              <span class="font-medium text-stone-700 text-right">{course.location}</span>
            </div>
          )}
        </div>

        <button class="w-full bg-[#B01A19] hover:bg-[#8f1514] text-white font-semibold py-3 px-6 rounded-xl transition-colors">
          S'inscrire
        </button>
      </aside>
    </div>

    {relatedCourses.length > 0 && (
      <section class="mt-16 pt-10 border-t border-stone-200 dark:border-stone-700">
        <h2 class="text-2xl font-bold text-stone-800 mb-6" style="font-family: var(--font-heading)">
          Autres formations
        </h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedCourses.map(c => (
            <a href={`/${labSlug}/academy/${c.slug}/`} class="group bg-white dark:bg-stone-900 rounded-xl border border-stone-200 overflow-hidden hover:shadow-md transition-shadow">
              <img src={c.image} alt={c.title} class="w-full h-40 object-cover" loading="lazy" />
              <div class="p-4">
                <h3 class="font-semibold text-stone-800 group-hover:text-[#B01A19] transition-colors">{c.title}</h3>
                <p class="text-sm text-stone-500 mt-1">{c.duration} · {c.price}€</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</WebsiteLayout>
