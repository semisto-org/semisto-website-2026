---
import BaseLayout from '../../../layouts/BaseLayout.astro'
import { CourseCatalog } from '../../../components/CourseCatalog'
import { getLabs, getLabBySlug, getCourses, getEvents, getLabSlugs } from '../../../lib/api'
import { breadcrumbJsonLd } from '../../../lib/seo'

export async function getStaticPaths() {
  const slugs = await getLabSlugs()
  return slugs.map(slug => ({ params: { labSlug: slug } }))
}

const { labSlug } = Astro.params
const labs = await getLabs()
const lab = await getLabBySlug(labSlug!)
if (!lab) return Astro.redirect('/404')

const courses = await getCourses(lab.id)
const events = await getEvents(lab.id)

const jsonLd = breadcrumbJsonLd([
  { name: 'Accueil', url: '/' },
  { name: lab.name, url: `/${labSlug}/` },
  { name: 'Academy', url: `/${labSlug}/academy/` },
])
---

<BaseLayout
  title={`Academy — ${lab.name}`}
  description={`Formations et événements proposés par ${lab.name}. Permaculture, design de jardins-forêts, multiplication végétale.`}
  labs={labs}
  currentLabSlug={labSlug}
  jsonLd={jsonLd}
>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-stone-800 mb-2" style="font-family: var(--font-heading)">
      Academy
    </h1>
    <p class="text-lg text-stone-500 mb-10">Formations et événements — {lab.name}</p>

    <CourseCatalog
      client:load
      courses={courses}
      labId={lab.id}
      onCourseView={(id) => {
        const c = courses.find(x => x.id === id)
        if (c) window.location.href = `/${labSlug}/academy/${c.slug}/`
      }}
      onCourseRegister={(id) => {
        const c = courses.find(x => x.id === id)
        if (c) window.location.href = `/${labSlug}/academy/${c.slug}/`
      }}
    />

    {events.length > 0 && (
      <div class="mt-16">
        <h2 class="text-2xl font-bold text-stone-800 mb-6" style="font-family: var(--font-heading)">
          Événements à venir
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {events.map(event => (
            <article class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden hover:shadow-md transition-shadow">
              <img src={event.image} alt={event.title} class="w-full h-48 object-cover" loading="lazy" />
              <div class="p-6">
                <span class="inline-block px-2 py-1 bg-[#B01A19]/10 text-[#B01A19] text-xs font-medium rounded-full mb-3">
                  {event.type}
                </span>
                <h3 class="text-lg font-semibold text-stone-800 mb-2">{event.title}</h3>
                <p class="text-sm text-stone-500 mb-3">{event.date} · {event.time} · {event.location}</p>
                <p class="text-sm text-stone-600 line-clamp-2">{event.description}</p>
                <div class="mt-4 flex items-center justify-between">
                  <span class="text-sm font-medium text-stone-700">{event.price}€</span>
                  <span class="text-xs text-stone-400">{event.spotsAvailable}/{event.spotsTotal} places</span>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>
    )}
  </section>
</BaseLayout>
