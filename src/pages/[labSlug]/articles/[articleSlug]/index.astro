---
import WebsiteLayout from '../../../../layouts/WebsiteLayout.astro'
import { getLabs, getLabBySlug, getArticles, getArticleBySlug } from '../../../../lib/api'
import { articleJsonLd, breadcrumbJsonLd } from '../../../../lib/seo'

export async function getStaticPaths() {
  const labs = await getLabs()
  const articles = await getArticles()
  return articles.map(article => {
    const lab = labs.find(l => l.id === article.labId)
    return { params: { labSlug: lab?.slug, articleSlug: article.slug } }
  }).filter(p => p.params.labSlug)
}

const { labSlug, articleSlug } = Astro.params
const labs = await getLabs()
const lab = await getLabBySlug(labSlug!)
const article = await getArticleBySlug(articleSlug!)
if (!lab || !article) return Astro.redirect('/404')

const relatedArticles = (await getArticles(lab.id)).filter(a => a.id !== article.id).slice(0, 3)

const jsonLd = [
  articleJsonLd(article),
  breadcrumbJsonLd([
    { name: 'Accueil', url: '/' },
    { name: lab.name, url: `/${labSlug}/` },
    { name: 'Articles', url: `/${labSlug}/articles/` },
    { name: article.title, url: `/${labSlug}/articles/${articleSlug}/` },
  ]),
]
---

<WebsiteLayout
  title={article.title}
  description={article.excerpt}
  image={article.image}
  labs={labs}
  currentLabSlug={labSlug}
  jsonLd={jsonLd}
  type="article"
>
  <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <nav class="text-sm text-stone-400 mb-6">
      <a href="/" class="hover:text-stone-600 dark:text-stone-400">Accueil</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/`} class="hover:text-stone-600 dark:text-stone-400">{lab.name}</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/articles/`} class="hover:text-stone-600 dark:text-stone-400">Articles</a>
      <span class="mx-2">›</span>
      <span class="text-stone-600 dark:text-stone-400">{article.title}</span>
    </nav>

    <img src={article.image} alt={article.title} class="w-full h-64 md:h-96 object-cover rounded-2xl mb-8" />

    <div class="flex items-center gap-3 mb-6">
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{article.category}</span>
      <span class="text-sm text-stone-400">{article.readingTime} min de lecture</span>
    </div>

    <h1 class="text-4xl md:text-5xl font-bold text-stone-800 mb-4 leading-tight" style="font-family: var(--font-heading)">
      {article.title}
    </h1>

    <div class="flex items-center gap-3 text-sm text-stone-500 mb-10">
      <span class="font-medium text-stone-700">{article.author}</span>
      <span>·</span>
      <span>{article.authorRole}</span>
      <span>·</span>
      <time datetime={article.publishedAt}>
        {new Date(article.publishedAt).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
    </div>

    <div class="prose prose-stone prose-lg max-w-none">
      <p class="text-xl text-stone-600 leading-relaxed">{article.excerpt}</p>
      <div set:html={article.content} />
    </div>

    {article.tags.length > 0 && (
      <div class="mt-10 pt-6 border-t border-stone-200 flex flex-wrap gap-2">
        {article.tags.map(tag => (
          <span class="px-3 py-1 bg-stone-100 text-stone-500 text-sm rounded-full">#{tag}</span>
        ))}
      </div>
    )}

    {relatedArticles.length > 0 && (
      <section class="mt-16 pt-10 border-t border-stone-200 dark:border-stone-700">
        <h2 class="text-2xl font-bold text-stone-800 mb-6" style="font-family: var(--font-heading)">
          Articles similaires
        </h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedArticles.map(a => (
            <a href={`/${labSlug}/articles/${a.slug}/`} class="group bg-white dark:bg-stone-900 rounded-xl border border-stone-200 overflow-hidden hover:shadow-md transition-shadow">
              <img src={a.image} alt={a.title} class="w-full h-40 object-cover" loading="lazy" />
              <div class="p-4">
                <h3 class="font-semibold text-stone-800 group-hover:text-[#AFBD00] transition-colors">{a.title}</h3>
                <p class="text-sm text-stone-500 mt-1">{a.readingTime} min · {a.author}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</WebsiteLayout>
