---
import BaseLayout from '../../../../layouts/BaseLayout.astro'
import { getLabs, getLabBySlug, getProjects, getProjectBySlug } from '../../../../lib/api'
import { breadcrumbJsonLd } from '../../../../lib/seo'

export async function getStaticPaths() {
  const labs = await getLabs()
  const projects = await getProjects()
  return projects.map(project => {
    const lab = labs.find(l => l.id === project.labId)
    return { params: { labSlug: lab?.slug, projectSlug: project.slug } }
  }).filter(p => p.params.labSlug)
}

const { labSlug, projectSlug } = Astro.params
const labs = await getLabs()
const lab = await getLabBySlug(labSlug!)
const project = await getProjectBySlug(projectSlug!)
if (!lab || !project) return Astro.redirect('/404')

const relatedProjects = (await getProjects(lab.id)).filter(p => p.id !== project.id).slice(0, 3)

const jsonLd = breadcrumbJsonLd([
  { name: 'Accueil', url: '/' },
  { name: lab.name, url: `/${labSlug}/` },
  { name: 'Projets', url: `/${labSlug}/projects/` },
  { name: project.title, url: `/${labSlug}/projects/${projectSlug}/` },
])
---

<BaseLayout
  title={project.title}
  description={project.shortDescription}
  image={project.images[0]}
  labs={labs}
  currentLabSlug={labSlug}
  jsonLd={jsonLd}
  type="article"
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <nav class="text-sm text-stone-400 mb-6">
      <a href="/" class="hover:text-stone-600">Accueil</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/`} class="hover:text-stone-600">{lab.name}</a>
      <span class="mx-2">›</span>
      <a href={`/${labSlug}/projects/`} class="hover:text-stone-600">Projets</a>
      <span class="mx-2">›</span>
      <span class="text-stone-600">{project.title}</span>
    </nav>

    {project.images.length > 0 && (
      <img src={project.images[0]} alt={project.title} class="w-full h-64 md:h-96 object-cover rounded-2xl mb-8" />
    )}

    <div class="flex flex-wrap gap-3 mb-4">
      <span class="px-3 py-1 bg-[#AFBD00]/10 text-[#AFBD00] text-sm font-medium rounded-full">{project.clientType}</span>
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{project.status}</span>
      <span class="px-3 py-1 bg-stone-100 text-stone-600 text-sm rounded-full">{project.surface} m²</span>
    </div>

    <h1 class="text-4xl font-bold text-stone-800 mb-4" style="font-family: var(--font-heading)">
      {project.title}
    </h1>

    <div class="grid md:grid-cols-3 gap-8">
      <div class="md:col-span-2 prose prose-stone max-w-none">
        <p class="text-lg text-stone-600">{project.description}</p>

        <div class="grid grid-cols-2 gap-4 my-8 not-prose">
          <div class="bg-stone-50 rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-stone-800">{project.surface}</div>
            <div class="text-xs text-stone-500 uppercase">m² transformés</div>
          </div>
          <div class="bg-stone-50 rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-stone-800">{project.treesPlanted}</div>
            <div class="text-xs text-stone-500 uppercase">arbres plantés</div>
          </div>
        </div>

        {project.testimonial && (
          <blockquote class="border-l-4 border-[#AFBD00] pl-4 italic text-stone-600 my-8">
            <p>"{project.testimonial.text}"</p>
            <footer class="text-sm font-medium text-stone-500 mt-2 not-italic">
              — {project.testimonial.author}, {project.testimonial.role}
            </footer>
          </blockquote>
        )}
      </div>

      <aside class="h-fit">
        {project.fundingStatus === 'active' && project.fundingGoal && (
          <div id="donate" class="bg-stone-50 rounded-2xl p-6 border border-stone-200">
            <h3 class="font-semibold text-stone-800 mb-3">Soutenir ce projet</h3>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-stone-500">{project.fundingRaised}€ récoltés</span>
                <span class="font-medium text-stone-700">{project.fundingGoal}€</span>
              </div>
              <div class="w-full bg-stone-200 rounded-full h-2">
                <div
                  class="bg-[#AFBD00] h-2 rounded-full"
                  style={`width: ${Math.min(100, ((project.fundingRaised || 0) / project.fundingGoal) * 100)}%`}
                />
              </div>
            </div>
            <button class="w-full bg-[#AFBD00] hover:bg-[#9aaa00] text-stone-900 font-semibold py-3 px-6 rounded-xl transition-colors">
              Faire un don
            </button>
          </div>
        )}

        <div class="bg-stone-50 rounded-2xl p-6 border border-stone-200 mt-4">
          <h3 class="font-semibold text-stone-800 mb-3">Localisation</h3>
          <p class="text-sm text-stone-600">{project.location}</p>
        </div>
      </aside>
    </div>

    {relatedProjects.length > 0 && (
      <section class="mt-16 pt-10 border-t border-stone-200">
        <h2 class="text-2xl font-bold text-stone-800 mb-6" style="font-family: var(--font-heading)">
          Autres projets
        </h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedProjects.map(p => (
            <a href={`/${labSlug}/projects/${p.slug}/`} class="group bg-white rounded-xl border border-stone-200 overflow-hidden hover:shadow-md transition-shadow">
              {p.images[0] && <img src={p.images[0]} alt={p.title} class="w-full h-40 object-cover" loading="lazy" />}
              <div class="p-4">
                <h3 class="font-semibold text-stone-800 group-hover:text-[#AFBD00] transition-colors">{p.title}</h3>
                <p class="text-sm text-stone-500 mt-1">{p.location} · {p.surface} m²</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
