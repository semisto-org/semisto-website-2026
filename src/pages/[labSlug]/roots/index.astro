---
import BaseLayout from '../../../layouts/BaseLayout.astro'
import { SemistoRoots } from '../../../components/SemistoRoots'
import { getLabs, getLabBySlug, getWorksites, getImpactStats, getLabSlugs } from '../../../lib/api'
import { breadcrumbJsonLd } from '../../../lib/seo'

export async function getStaticPaths() {
  const slugs = await getLabSlugs()
  return slugs.map(slug => ({ params: { labSlug: slug } }))
}

const { labSlug } = Astro.params
const labs = await getLabs()
const lab = await getLabBySlug(labSlug!)
if (!lab) return Astro.redirect('/404')

const worksites = await getWorksites(lab.id)
const impactStats = await getImpactStats()

const jsonLd = breadcrumbJsonLd([
  { name: 'Accueil', url: '/' },
  { name: lab.name, url: `/${labSlug}/` },
  { name: 'Semisto Roots', url: `/${labSlug}/roots/` },
])
---

<BaseLayout
  title={`Semisto Roots — ${lab.name}`}
  description={`Rejoignez les Food Forest Heroes ! Participez aux chantiers participatifs de ${lab.name} et plantez des arbres.`}
  labs={labs}
  currentLabSlug={labSlug}
  jsonLd={jsonLd}
>
  <SemistoRoots
    client:load
    lab={lab}
    upcomingWorksites={worksites}
    impactStats={{ volunteersActive: impactStats.volunteersActive, treesPlanted: impactStats.treesPlanted }}
    onWorksiteView={(id) => {}}
    onWorksiteRegister={(id) => { alert('Inscription enregistrée !') }}
    onJoinHeroes={() => { alert('Bienvenue chez les Food Forest Heroes !') }}
  />
</BaseLayout>
